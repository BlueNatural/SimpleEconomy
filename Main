package com.simpleeconomy.bluenatural;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.Server;
import org.bukkit.Sound;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.command.ConsoleCommandSender;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.PluginDescriptionFile;
import org.bukkit.plugin.RegisteredServiceProvider;
import org.bukkit.plugin.java.JavaPlugin;

import net.md_5.bungee.api.ChatColor;
import net.milkbowl.vault.economy.Economy;
import net.milkbowl.vault.economy.EconomyResponse;

public class Main extends JavaPlugin implements Listener {
	public static Plugin plugin;
	public static Server server;
	public static String pluginName;
	public static String pluginVersion;
	private static Economy econ = null;
	public static EconomyResponse r;
	String cslprefix = "[SimpleEconomy] ";
	
	@Override
    public void onLoad()
    {
	    plugin = this;
        server = plugin.getServer();
        NLog.setPluginLogger(plugin.getLogger());
        NLog.setServerLogger(plugin.getLogger());
        pluginName = plugin.getDescription().getName();
        pluginVersion = plugin.getDescription().getVersion();
        this.saveDefaultConfig();
    }
	public void loadingConfiguration(){
		String prefix = "prefix";
		plugin.getConfig().addDefault(prefix, "&7&l[&eSimple&cEconomy&7&l] ");
		
		String successfulsound = "successful-sound";
		plugin.getConfig().addDefault(successfulsound, "ENTITY_PLAYER_LEVELUP");
		String failingsound = "failing-sound";
		plugin.getConfig().addDefault(failingsound, "ITEM_SHIELD_BREAK");
		
		String depositcomplete = "deposit-complete";
		plugin.getConfig().addDefault(depositcomplete, "&aLấy tiền thành công");
		String depositfailing = "deposit-failing";
		plugin.getConfig().addDefault(depositfailing, "&cKhông đủ tiền,lấy tiền thất bại");
		
		String withdrawcomplete = "withdraw-complete";
		plugin.getConfig().addDefault(withdrawcomplete, "&aRút tiền thành công");
		
		String transfermsg = "transfer-msg";
		plugin.getConfig().addDefault(transfermsg, "&aĐã chuyển số tiền theo yêu cầu là");
		String failtransfer = "fail-transfer";
		plugin.getConfig().addDefault(failtransfer, "&cChuyển tiền thất bại,không đủ số tiền là");
		
		String successfultitle = "successful-title";
		plugin.getConfig().addDefault(successfultitle, "&aTHÀNH CÔNG !");
		
		String reload = "reload";
		plugin.getConfig().addDefault(reload, "&aReload Successfully !");
		
		String noperm = "no-perm";
		plugin.getConfig().addDefault(noperm, "&cYou do not have permission to do that ! Do not do this again !");
		
		String stayingtime = "staying-time";
		plugin.getConfig().addDefault(stayingtime, Integer.valueOf(4));
		//20 ticks * 4 = 80 ticks
	    //Show how much title appear and disappear
		
		getConfig().options().copyDefaults(true);
		saveDefaultConfig();
		
	}
	PluginDescriptionFile pdf = getDescription();
	@Override 
	public void onEnable(){
		ConsoleCommandSender console = getServer().getConsoleSender();
		if(setupEconomy()){
			plugin = this;
			getServer().getPluginManager().enablePlugin(this);
			console.sendMessage(this.cslprefix + ChatColor.GREEN + "The plugin will start in a few seconds");
			getServer().getPluginManager().registerEvents(this, this);
			loadingConfiguration();
			console.sendMessage(this.cslprefix + ChatColor.YELLOW + "The plugin started");
			console.sendMessage(this.cslprefix + ChatColor.AQUA + pdf.getName() + pdf.getVersion());
		}else if(!setupEconomy()){
			console.sendMessage(this.cslprefix + ChatColor.RED + "Not found it,sure you have been installed Vault before starting this plugin");
			getServer().getPluginManager().disablePlugin(this);
		}
	}
	private boolean setupEconomy() {
		if (getServer().getPluginManager().getPlugin("Vault") == null) {
			return false;
			}
			RegisteredServiceProvider<Economy> rsp = getServer().getServicesManager().getRegistration(Economy.class);
			if (rsp == null) {
				return false;
			}
			econ = (Economy) rsp.getProvider();
			return econ != null;
		
	}
	@EventHandler
	public void onJoin(PlayerJoinEvent e){
	for (Player pl : getServer().getOnlinePlayers()) {
		
	}
				
			}	

	@SuppressWarnings("deprecation")
	public boolean onCommand(CommandSender sender, Command cmd, String commandLabel, String[] args) {
		ConsoleCommandSender console = Bukkit.getConsoleSender();
		if (!(sender instanceof Player)) {
			console.sendMessage(this.cslprefix + ChatColor.RED + "This command only use in game");				
			}else{
				Player p = (Player) sender;
				Location loc = p.getLocation();
				if(cmd.getName().equalsIgnoreCase("simpleeconomy")){
					if(args.length < 1){
						if(p.hasPermission("se.help")){
							p.playSound(loc, Sound.CHEST_CLOSE, 4.0F, 1.0F);
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&7&m------------------------------------------------"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy deposit &7chuyển tiền vào ngân hàng"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy withdraw &7rút số tiền từ ngân hàng"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy show &7xem tài khoản người chơi"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy pay &7lấy số tiền của mình để gửi"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy reset &7reset lại tiền của một ai đó"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&b/simpleeconomy reload &7reload plugin"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&ePlugin made by &bBlueNatural"));
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&7&m------------------------------------------------"));
							return true;
						}else{
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
									ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
							p.playSound(loc, Sound.BLAZE_HIT, 4F, 1F);
							return true;
						}
						}else if(args.length == 3 && args[0].equalsIgnoreCase("deposit")){
						   if(p.hasPermission("so.deposit")){
							Player target = Bukkit.getPlayer(args[1]);
							double depositAmount = Double.valueOf(args[2]);
							econ.depositPlayer(target, depositAmount);
							if(r.transactionSuccess()){
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
									ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("deposit-complete"))+ r.amount);
							Titles.sendTitle(p, ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("successful-title")), "", 20, Main.this.getConfig().getInt("staying-time") *20, 20);
							p.playSound(loc, Sound.valueOf(Main.this.getConfig().getString("successful-sound")), 4.0F, 1.0F);
							return true;
						}else{
							p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
									ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("deposit-failing"))+ r.amount);
							return true;			
						}
						   
				}else{
					p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
							ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
					p.playSound(loc, Sound.ANVIL_BREAK, 4.0F, 1F);
				}
					}else if(args.length == 1 && args[0].equalsIgnoreCase("show")){
					if(p.hasPermission("se.show")){
					p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&aSố tiền của" + p.getDisplayName() + "là" + econ.getBalance(p)));
					return true;
				}else{
					p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
							ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
					p.playSound(loc, Sound.BLAZE_HIT, 4F, 1F);
					return true;
					
				}					
				}else if(args.length == 3 && args[0].equalsIgnoreCase("withdraw")){
					if(p.hasPermission("se.withdraw")){
						Player target = Bukkit.getPlayer(args[1]);
						Double withdraw = Double.valueOf(args[2]);
					    		r = econ.withdrawPlayer(target, withdraw);
					    	if(r.transactionSuccess()){
					    		Titles.sendTitle(p, ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("successful-title")), "", 20, Main.this.getConfig().getInt("staying-time"), 20);
					    		p.playSound(loc, Sound.valueOf(Main.this.getConfig().getString("successful-sound")), 4.0F, 1.0F);
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("withdraw-complete")));
					    		return true;
					    	}else{
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("Failing to send money to system ! You need to have high or equal" + r.amount)));
					    		p.playSound(loc, Sound.valueOf(Main.this.getConfig().getString("failing-sound")), 4F, 1F);			
					    		return true;
					    	}
					    	}else{
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
										ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
								p.playSound(loc, Sound.ANVIL_BREAK, 4.0F, 1F);	
								return true;
					    	}
					    }else if(args.length == 2 && getName().equalsIgnoreCase("reset")){
					    	if(p.hasPermission("se.reset")){
					    		Player target = Bukkit.getPlayer(args[1]);
					             r = econ.withdrawPlayer(target, econ.getBalance(target));
					             if(r.transactionSuccess()){
					            	 Titles.sendTitle(p, ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("successful-title")), "", 20, Main.this.getConfig().getInt("staying-time"), 20);
					            	 p.playSound(loc, Sound.valueOf(Main.this.getConfig().getString("successful-sound")), 4.0F, 1.0F);
					            	 p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
					            			 ChatColor.translateAlternateColorCodes('&', "&aĐã reset số tiền của người chơi") + r.balance);
					            	 return true;
					            	 
					             }else{
					            	p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
					            			ChatColor.translateAlternateColorCodes('&', "&cFailing to reset money !!"));
					            	return true;
					             }
					             
					    	}else{
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
										ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
								p.playSound(loc, Sound.ANVIL_BREAK, 4.0F, 1F);	
								return true;	
					    	}
					    }else if(args.length == 1 && args[0].equalsIgnoreCase("reload")){
					    	if(p.hasPermission("se.reload")){
					    		ReloadPlugin();
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
					    				ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("reload")));
					    		return true;
					    	
					    	}else{
					    		p.sendMessage(ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("prefix"))+ 
										ChatColor.translateAlternateColorCodes('&', Main.this.getConfig().getString("no-perm")));
								p.playSound(loc, Sound.ANVIL_BREAK, 4.0F, 1F);	
								return true;	
					    	}
					    }
						}
					}
		return true;
						}
	private void ReloadPlugin() {
		plugin.reloadConfig();
		plugin.saveConfig();
		
		
	}
				}
			
